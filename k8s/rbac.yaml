apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: istio-oauth-service
rules:
  - apiGroups:
      - ""
      - "extensions"
      - "apps"
    resources:
      - services
      - pods
      - endpoints
      - namespaces
      - configmaps
      - secrets
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: istio-oauth-service
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: istio-oauth-service
subjects:
  - kind: ServiceAccount
    name: default
#---
#apiVersion: "security.istio.io/v1beta1"
#kind: "PeerAuthentication"
#metadata:
#  name: "default"
#  namespace: "default"
#spec:
#  mtls:
#    mode: STRICT
---
apiVersion: "security.istio.io/v1beta1"
kind: "RequestAuthentication"
metadata:
  name: "request-authentication-jwt"
  namespace: istio-system
  labels:
    app: request-authentication-jwt
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  jwtRules:
    - issuer: "https://istio-oauth-service.com"
      jwksUri: "http://istio-oauth-service.default.svc.cluster.local:9999/.well-known/jwks.json"
---
apiVersion: "security.istio.io/v1beta1"
kind: "AuthorizationPolicy"
metadata:
  name: "authorization-policy"
  namespace: istio-system
  labels:
    app: authorization-policy
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  action: DENY
  rules:
    - from:
        - source:
            namespaces: ["istio-system"]
      to:
        - operation:
            paths: ["/api"]
#---
#apiVersion: "security.istio.io/v1beta1"
#kind: "AuthorizationPolicy"
#metadata:
#  name: "allow-jwks-ingress"
#  namespace: istio-system
#spec:
#  selector:
#    matchLabels:
#      istio: ingressgateway
#  action: ALLOW
#  rules:
#    - to:
#        - operation:
#            paths: ["/.well-known/jwks.json"]
#---
#kind: ClusterRoleBinding
#apiVersion: rbac.authorization.k8s.io/v1
#metadata:
#  name: kubelet-api-admin
#subjects:
#  - kind: User
#    name: kube-apiserver-kubelet-client
#    apiGroup: rbac.authorization.k8s.io
#roleRef:
#  kind: ClusterRole
#  name: system:kubelet-api-admin
#  apiGroup: rbac.authorization.k8s.io